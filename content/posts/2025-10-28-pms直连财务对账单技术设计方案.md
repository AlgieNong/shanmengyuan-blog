---
title: PMS直连财务对账单技术设计方案
date: 2025-10-29T01:08:00.000+08:00
tags:
  - 技术方案
excerpt: >+
  为了实现一体化对账，需要支持直连交易数据的导出，以便在PMS系统内完成对账。系统需要提供PMS直连财务对账单的下载功能，基于日历房结算对账单数据，通过调用外部系统接口获取额外信息进行拼装。

heroImage: /smy-blog.github.io/images/snipaste_2025-10-29_01-09-30.png
draft: false
---
## 1. 需求概述

### 1.1 业务背景

为了实现一体化对账，需要支持直连交易数据的导出，以便在PMS系统内完成对账。系统需要提供PMS直连财务对账单的下载功能，基于日历房结算对账单数据，通过调用外部系统接口获取额外信息进行拼装。

### 1.2 核心目标

1. 提供配置信息查询接口（业务线、渠道平台类型）
2. 提供预约下载接口，支持按日期、业务线、渠道平台类型筛选
3. 基于`order_settlement_log`结算对账单，调用直连系统、日历房系统批量查询接口获取额外字段
4. 支持西软标准格式导出（Excel/CSV）

### 1.3 技术要求

* 复用现有预约下载框架
* 支持日期分片处理
* 批量调用外部系统接口
* 集团主店支持导出所有门店数据

## 2. 系统架构设计

### 2.1 整体架构图

```plantuml
@startuml
!theme plain

actor "EB前端" as Frontend
box "结算系统" #LightBlue
  participant "结算系统API" as Settlement
end box

box "消息队列" #LightYellow
  participant "MQ" as MQ
end box

box "外部系统" #LightGreen
  participant "日历房系统" as RoomSystem
  participant "直连系统" as DirectSystem
end box

box "存储服务" #LightPink
  participant "OSS" as OSS
end box

== 配置查询 ==
Frontend -> Settlement: 查询配置信息
note right
  获取：
  - 业务线列表
  - 渠道平台类型列表
end note
Settlement --> Frontend: 返回配置信息

== 预约下载 ==
Frontend -> Settlement: 提交下载请求
note right
  参数：
  - 日期范围
  - 业务线
  - 渠道平台类型
end note
Settlement -> MQ: 发送下载消息
Settlement --> Frontend: 返回预约成功

== 异步处理 ==
MQ -> Settlement: 消费下载消息

loop 按日期分片处理
  Settlement -> Settlement: 查询结算对账单数据(order_settlement_log)
  note right
    获取：订单号、业务线、酒店ID
    交易服务费、系统服务费
  end note
  
  Settlement -> RoomSystem: 批量查询日历房订单信息
  note right
    每批100条
    获取：客人姓名、入住/离店日期
    房号、间夜、房型名称、确认号
    PMS订单号、币种、金额数据
  end note
  RoomSystem --> Settlement: 返回订单信息
  
  Settlement -> DirectSystem: 批量查询直连订单信息
  note right
    每批100条
    获取：总房价取值规则
    (订单金额/实付金额)
  end note
  DirectSystem --> Settlement: 返回直连规则
  
  Settlement -> Settlement: 数据拼装
  note right
    根据直连规则从日历房数据
    中获取总房价
    底价 = 总房价 - 佣金
  end note
  Settlement -> OSS: 写入文件片段
end

Settlement -> OSS: 上传完整文件
Settlement -> Settlement: 更新下载状态为成功

Frontend -> Settlement: 查询下载明细获取状态
Frontend -> OSS: 下载文件

@enduml
```

## 3. 核心功能设计

### 3.1 接口设计

#### 3.1.1 配置查询接口

**接口路径**: `GET settlement-api/eb/pms/settlement/bill/config`

**请求参数**: 无

**响应示例**:

```json
{
  "code": "0",
  "message": "成功",
  "data": {
    "businessTypes": [
      {"code": 1003, "name": "日历房"}
    ],
    "channelList": [
      {"code": "XSOFT", "name": "西软"}
    ]
  }
}
```

#### 3.1.2 下载接口

**接口路径**: `POST settlement-data-pump-api/eb/appointment/download/pms/financial/download`

**请求参数**:

```json
{
    "downloadBizType": "61165",
    "startTime": "2025-09-16 00:00:00",
    "endTime": "2025-10-15 23:59:59",
    "searchTypeName": "结账日期",
    "supplierId": 184569,
    "timeType": "check", //结账日期
    "param": {
        "createTimeStart": "2025-09-16 00:00:00",
        "createTimeEnd": "2025-10-15 23:59:59",
        "timeType": "check",
        "hotelId": 184569,
        "businessTypes": [1003],      // 业务线：客房
        "channelPlatform": "XSOFT"     // 渠道平台类型：西软
    }
}
```

**响应示例**:

```json
{
  "code":"0",
  "message":"success",
  "data":1,
  "success":true
}
```

### 3.2 数据流程设计

#### 3.2.1 业务处理流程

```plantuml
@startuml
!theme plain
start

:接收下载请求;
:验证参数;

if (参数校验) then (失败)
  :返回错误信息;
  stop
else (成功)
  :生成预约下载记录;
  :发送MQ消息;
  :返回预约成功;
endif

fork
  :前端轮询下载状态;
fork again
  :MQ消费者接收消息;
  
  :日期范围分片;
  note right
    按天分片，避免
    单次查询数据量过大
  end note
  
  partition "循环处理每个日期片段" {
    :查询结算对账单数据;
    note right
      从order_settlement_log查询
      筛选条件：
      1. 核销日期范围
      2. 业务线=客房
      3. 渠道=西软
      4. 结算状态=已结算
      获取：订单号、业务线、酒店ID
      交易服务费、系统服务费
    end note
    
    :提取订单ID列表;
    :按100条分批处理;
    
    fork
      :批量查询日历房订单;
      note right
        根据：订单号、酒店ID
        获取字段：
        - 客人姓名
        - 入住/离店日期
        - 房号、间夜
        - 房型名称、确认号
        - PMS订单号、币种
        - 金额数据
      end note
    fork again
      :批量查询直连信息;
      note right
        根据：订单号、业务线、酒店ID
        获取：总房价取值规则
        (订单金额/实付金额)
      end note
    end fork
    
    :数据拼装;
    note right
      1. 基础数据来自结算单
      2. 详细数据来自日历房
      3. 根据直连规则从日历房
         数据中获取总房价
      4. 计算底价=总房价-佣金
    end note
    
    :写入文件;
  }
  
  :上传OSS;
  :更新下载记录状态;
  :发送通知;
end fork

:前端获取下载链接;
:用户下载文件;

stop
@enduml
```

#### 3.2.2 数据拼装逻辑

```plantuml
@startuml
!theme plain

participant "结算系统" as Settlement
participant "日历房系统" as RoomSystem
participant "直连系统" as DirectSystem

Settlement -> Settlement: 查询结算对账单数据
activate Settlement
note right
  从order_settlement_log查询
  获取：订单号、业务线、酒店ID
  交易服务费、系统服务费
end note

Settlement -> Settlement: 提取订单ID列表
Settlement -> Settlement: 按100条分批

Settlement -> RoomSystem: 批量查询日历房订单
note right
  入参：订单号、酒店ID列表
  批次大小：100个/批
end note
activate RoomSystem
RoomSystem --> Settlement: 返回日历房订单信息
deactivate RoomSystem
note left
  返回字段：
  - 客人姓名
  - 入住/离店日期
  - 房号、间夜
  - 房型名称、确认号
  - PMS订单号、币种
  - 金额数据
end note

Settlement -> DirectSystem: 批量查询直连订单
note right
  入参：订单号、业务线、酒店ID列表
  批次大小：100个/批
end note
activate DirectSystem
DirectSystem --> Settlement: 返回直连规则信息
deactivate DirectSystem
note left
  返回字段：
  - 总房价取值规则
    (订单金额/实付金额)
end note

Settlement -> Settlement: 构建索引映射表
note right
  建立订单ID快速查找索引
end note

Settlement -> Settlement: 遍历结算记录进行数据拼装
note right
  1. 基础数据来自结算单
  2. 详细数据来自日历房
  3. 根据直连规则从日历房获取总房价
  4. 计算底价=总房价-佣金
end note

Settlement -> Settlement: 返回完整数据集
deactivate Settlement

@enduml
```

### 3.3 批量查询策略

#### 3.3.1 批量大小控制

| 配置项       | 配置值 | 说明         |
| --------- | --- | ---------- |
| 日历房订单批量大小 | 100 | 每批查询100个订单 |
| 直连订单批量大小  | 100 | 每批查询100个订单 |

#### 3.3.2 批量处理流程

```plantuml
@startuml
!theme plain
start

:获取订单ID列表;
:按批次大小分组;

while (还有待处理批次?) is (是)
  :取出一批订单ID;
  
  :调用批量查询接口;
  note right
    失败直接抛出异常
    不进行重试
  end note
  
  :收集返回结果;
  
endwhile (否)

:返回所有结果;

stop
@enduml
```

- - -

## 4. 文件导出优化方案

### 4.1 背景说明

当前系统使用CSV格式进行异步下载，虽然支持大批量数据导出，但无法满足复杂格式定制需求（如多样式、合并单元格等）。为支持不同对账单的个性化导出需求，引入EasyExcel作为新的导出方式。

### 4.2 当前架构分析

#### 4.2.1 现有CSV导出架构

```plantuml
@startuml
skinparam backgroundColor #EEEBDC

participant "下载处理服务" as Handle
participant "下载服务" as Service
participant "数据服务1" as DS1
participant "数据服务2" as DS2
participant "CSV写入" as CSV

Handle -> Handle : 获取配置
loop 遍历每个数据服务
  Handle -> Service : 下载处理
  
  loop 时间分片
    loop 分页查询
      Service -> DS1 : 查询数据
      DS1 -> Service : 返回数据
      Service -> CSV : 追加写入
    end
  end
end

Handle -> Handle : 上传OSS

@enduml
```

**特点：**

* ✅ **内存友好**：CSV支持追加写入，流式处理
* ✅ **大数据支持**：支持百万级数据导出
* ❌ **格式单一**：无法实现复杂Excel样式

#### 4.2.2 EasyExcel架构挑战

EasyExcel要求在单一Writer上下文中完成所有写入，不支持跨方法追加，这与现有的"外层循环写入"架构冲突。

```plantuml
@startuml
skinparam backgroundColor #FFE4E1
skinparam rectangleBackgroundColor #FFEFD5
skinparam rectangleBorderColor #CD853F

rectangle "当前架构" #LightYellow {
  rectangle "外层Service循环" as loop1
  rectangle "内层时间分片+分页" as loop2
  rectangle "CSV追加写入" as csv
  
  loop1 -down-> loop2
  loop2 -down-> csv
}

rectangle "EasyExcel要求" #LightCyan {
  rectangle "单一Writer上下文" as writer
  rectangle "一次性写入完成" as once
  
  writer -down-> once
}

note right of csv
  每次调用都是独立的文件操作
  支持多次追加
end note

note right of once
  必须在一个方法内完成
  不能跨方法保持Writer状态
end note

csv -[#red,thickness=2]-> once
note on link #Pink
  <color:red><b>架构冲突</b></color>
  CSV可以追加，但EasyExcel
  需要在单一上下文中完成
end note

@enduml
```

### 4.3 解决方案设计

#### 4.3.1 核心思路

**从"外层循环写入"改为"内层循环查询"**

* **当前架构**：外层for循环Service → 内层时间分片 → 每次循环都写入文件
* **新架构**：单次下载方法 → 内层for循环Service → 内层时间分片 → 一次性写入完成

#### 4.3.2 双模式架构

系统支持CSV和EasyExcel两种导出模式，通过配置灵活切换：

```plantuml
@startuml
skinparam backgroundColor #EEEBDC

package "下载配置层" {
  class DownloadSetting {
    + downloadMode: 下载模式
    + easyExcelExecutor: 执行器
  }
  
  enum DownloadMode {
    CSV_MODE
    EASY_EXCEL_MODE
  }
}

package "下载处理层" {
  class DownloadHandleService {
    + billDataDownloadHandle()
  }
}

package "执行器层(新增)" #LightBlue {
  abstract class AbstractEasyExcelDownloadExecutor {
    + execute()
    # doExecute()
    # splitTimeRange()
  }
  
  class SupplierBillExecutor {
    + doExecute()
  }
}

package "原有CSV层" {
  class DownloadService
  class AsyncDownload
}

DownloadSetting --> DownloadMode
DownloadSetting --> AbstractEasyExcelDownloadExecutor
DownloadHandleService --> DownloadSetting
DownloadHandleService --> AbstractEasyExcelDownloadExecutor : EasyExcel模式
DownloadHandleService --> DownloadService : CSV模式
AbstractEasyExcelDownloadExecutor <|-- SupplierBillExecutor

@enduml
```

#### 4.3.3 EasyExcel导出流程

```plantuml
@startuml
skinparam backgroundColor #EEEBDC

participant "MQ" as mq
participant "下载处理服务" as handle
participant "EasyExcel执行器" as executor
participant "数据服务" as ds
participant "EasyExcel" as excel

mq -> handle : 接收消息
handle -> handle : 判断下载模式

alt downloadMode == EASY_EXCEL_MODE
  handle -> executor : 执行下载
  executor -> excel : 创建ExcelWriter
  
  loop 遍历每个数据服务
    loop 时间分片
      loop 分页查询
        executor -> ds : 查询数据
        ds -> executor : 返回数据
        executor -> excel : 批量写入
      end
    end
  end
  
  executor -> excel : 关闭Writer
  executor -> executor : 上传OSS
else downloadMode == CSV_MODE
  handle -> handle : 走原有CSV流程
end

handle -> mq : 发送完成通知

@enduml
```

### 4.4 架构设计要点

#### 4.4.3 时间分片处理

```plantuml
@startuml
!theme plain
start

:接收下载请求;
:获取时间范围;

:按天分片;
note right
  避免单次查询
  数据量过大
end note

:创建ExcelWriter;
note right: EasyExcel执行器内部开始

repeat :遍历时间分片;
  :设置当前时间段;
  
  repeat :分页查询;
    :查询数据;
    :批量写入Excel;
  repeat while (还有数据?) is (是)
  ->否;
  
repeat while (还有时间片?) is (是)
->否;

:关闭Writer;
note right: EasyExcel执行器内部结束

:上传OSS;
:发送通知;

stop
@enduml
```

### 4.5 方案对比

| 对比维度     | CSV模式       | EasyExcel模式      |
| -------- | ----------- | ---------------- |
| **格式能力** | 仅CSV格式      | 支持复杂Excel样式      |
| **循环位置** | 外层Service循环 | 内层Service循环      |
| **写入方式** | 追加写入        | 批量写入             |
| **内存占用** | 低（流式）       | 中（批量）            |
| **扩展性**  | 格式固定        | 可自定义样式           |
| **适用场景** | 大数据量、简单格式   | 中等数据量、复杂格式       |
| **性能表现** | 未测试         | 100万条/23.4秒/60MB |

### 4.6 性能测试

#### 4.6.1 测试环境

**测试配置**：

* 测试数据量：100万条记录
* 导出模式：EasyExcel模式
* 数据内容：PMS直连财务对账单完整字段

#### 4.6.2 测试结果

| 性能指标     | 测试结果             | 说明             |
| -------- | ---------------- | -------------- |
| **数据量**  | 100万条            | 模拟真实对账单数据      |
| **总耗时**  | 23,441ms（约23.4秒） | 不包括查询，仅包括导出    |
| **文件大小** | 60MB             | Excel格式（.xlsx） |
| **平均速度** | ~42,700条/秒       | 包含数据写入         |

#### 4.6.3 性能分析

**性能表现**：

* ✅ **高吞吐量**：每秒处理超过4万条记录，满足大批量导出需求
* ✅ **时效性好**：23秒完成百万级数据导出，满足异步下载场景

**优化建议**：

* 如单次导出超过100万条，建议按时间范围拆分多个文件
* 可根据实际业务需求调整批量查询大小以平衡内存和性能

### 4.7 兼容性设计

**向后兼容**：

* 原有CSV模式保持不变
* 新对账单可选择使用EasyExcel模式
* 通过配置灵活切换
